# AWS Creator Node Deployment

AWS Services:

ECR - Elastic container Registry, used to store private repository images

ECS - Elastic container service, used to deploy containers

EC2 - Elastic compute cloud, service backing container deployment through ECS

VPC - Virtual private cloud



#### Requirements:

- Install and configure AWS CLI - there are several ways to install this which can be [found in the official documentation here](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html)

- Create IAM user or retrieve access key and secret for existing user

  - IAM User must have relevant ECS permissions, for internal audius development please ensure user has been added to 'ecs-users'

  * NOTE - The name of your IAM user, access key, and secret key are all relevant throughout this process. Please note them carefully

* Configure AWS Cli with this user

  * Example:

    ```
    AWS Access Key ID [None]: <key-id>
    AWS Secret Access Key [None]: <secret-key-id>
    Default region name [None]: us-west-1
    Default output format [None]: json
    ```

#### ECR Setup

(skip this if you are primarily interested in deploying the creator node)

* Register new repository in ECR dashboard

* All ECR permissions for above IAM user must be enabled to allow private image updates. Found under ECR -> Repositories -> Permissions tab

* Navigate to Repositories, select the newly created repo, and navigate to the 'Images' tab - on the top right of this page, click the 'View push commands' button to retrieve a series of commands you can use '

Here are the commands returned during the setup of the audius-creator-node image:

```
$(aws ecr get-login --no-include-email --region us-west-1)

docker build -t audius-creator-node .

docker tag audius-creator-node:latest 526177477460.dkr.ecr.us-west-1.amazonaws.com/audius-creator-node:latest

docker push 526177477460.dkr.ecr.us-west-1.amazonaws.com/audius-creator-node:latest
```



## ECS Cluster Setup + Deployment

##### Step 0 - Optional, export an environment variable with your desired cluster name

```
$ export ECS_CLUSTER_NAME=audius-creator-node-1
```

This variable is used throughout examples for readability, but is not required for correctness or functionality -



#### Step 1 - Register a new cluster configuration

```
$ ecs-cli configure --cluster $ECS_CLUSTER_NAME --region us-west-1 --default-launch-type EC2 --config-name $ECS_CLUSTER_NAME
INFO[0000] Saved ECS CLI cluster configuration audius-creator-node-1.
```



#### Step 2 - Create the cluster if it does not yet exist

Required values - Security Group (SG), Virtual Private Cloud (VPC) ID, Subnet,EC2 keypair

SG - found under EC2 dashboard, corresponds to VPC ID

VPC - Root level AWS service, same level as EC2

Subnet - Found under VPC dashboard

EC2 Key Pair - Required for SSH operations, found under EC2 dashboard (audius-alpha in below example)

```
$ ecs-cli up --keypair audius-alpha --capability-iam --size 1 --instance-type t2.medium \
	--cluster-config  $ECS_CLUSTER_NAME \
  --security-group sg-0326d39c5ba9b3d6e \
  --vpc vpc-016ae358cbd4b6fbb \
  --subnets subnet-07ee24688fa48d242,subnet-0b9cdb23761d05e57
```

Note that this refers to the cluster of cloud resources which back the container deployment - there are no containers yet running at the end of this step.



Be sure to use an existing VPC as there is an upper limit of 5. If not specified, a new VPC will be created which IS NOT DESIRABLE



### Step 3 - Deploy containers



From the /docker-compose directory (same level as docker-compose.aws.yml and ecs-params.yml files):

```
/audius-creator-node/docker-compose (develop)
$ ecs-cli compose --file docker-compose.aws.yml --ecs-params ecs-params.yml up \
	--create-log-groups --cluster-config $ECS_CLUSTER_NAME
```



Example  (abridged)output:

```
INFO[0002] Starting container...container=audius-creator-node1/dec4861db4df4ecaafc4796891216c10/creator-node
  
INFO[0002] Describe ECS container status                 container=audius-creator-node-1/dec4861db4df4ecaafc4796891216c10/db desiredStatus=RUNNING lastStatus=PENDING taskDefinition="docker-compose:3"

INFO[0046] Started container...                          container=audius-creator-node-1/dec4861db4df4ecaafc4796891216c10/creator-node desiredStatus=RUNNING lastStatus=RUNNING taskDefinition="docker-compose:3"
```



#### Step 4 - Create + associate application load balancer

Found under EC2 dashboard, under 'Load Balancers'



**Required values - Auto Scaling Group name, Target Group ARNS, VPC**



**Auto Scaling Group Name** - found under EC2 dashboard -> Auto Scaling, should have been autogenerated when deploying cluster. This name will contain 'EcsInstanceAsg'.

    Example: :amazon-ecs-cli-setup-creator-node-ec2-EcsInstanceAsg-WQEP1819YRBJ



**Target Group ARNS**

Can either create target group independently, or do so during load balancer deployment.

Represents a rule from the load balancer to the EC2 instance, ie forward requests to external port 80 to internal port 8000.

Found under 'Target group' -> 'Basic Configuration' in EC2 Dashboard

- Ex: arn:aws:elasticloadbalancing:us-west-1:526177477460:targetgroup/testTarget8k/bd3980faf5f7ff43

  

**VPC ID** - From previous step, must match ECS VPC. Required during creation of load balancer



Creating load balancer:

1. From EC2 dashboard, create Application Load Balancer

   1. Select "internet-facing"

   2. Select relevant availability zones, there should be 1/subnet

2. Configure routing by selecting an existing target or adding a new one

   1. This represents the port to which default requests are forwarded, so setting 8000 here will forward all incoming requests to port 80 to 8000 inside the load balancer



Now, we have created a load balancer as well as an ECS deployment - however, the two entities are still separate. To associate them, execute the below command:

```
$ aws autoscaling attach-load-balancer-target-groups --auto-scaling-group-name <auto-scale-group> --target-group-arns <target-arns>
```

Example with real values:

```
$ aws autoscaling attach-load-balancer-target-groups --auto-scaling-group-name amazon-ecs-cli-setup-audius-creator-node-1-EcsInstanceAsg-1B4BSBT5Z879Z --target-group-arns arn:aws:elasticloadbalancing:us-west-1:526177477460:targetgroup/test-creator-node-1-8k/663ba28683aa4ff1
```

#### Step 6 (Optional) - Testing

Test 1 - Verify EC2 public DNS endpoint available

Retrieve ec2 address from instance box, ex. ec2-13-52-75-114.us-west-1.compute.amazonaws.com



Example:

```
curl -X POST  http://ec2-13-52-75-114.us-west-1.compute.amazonaws.com:8000/users
```

Note that the port is necessary above



Test 2 - Verify LB public endpoint is available

    Retrieve LB DNS record and test endpoint similarly



Example:

```
curl -X POST \ http://audius-creator-lb-369142209.us-west-1.elb.amazonaws.com/users
```



Note that in the above, we do not require the port since our target group forwards external port 80 to internal port 8000








